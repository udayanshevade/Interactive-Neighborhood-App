var app=app||{},initializeMap=function(){var a=[{featureType:"administrative.locality",elementType:"all",stylers:[{hue:"#2c2e33"},{saturation:7},{lightness:19},{visibility:"on"}]},{featureType:"landscape",elementType:"all",stylers:[{hue:"#ffffff"},{saturation:-100},{lightness:100},{visibility:"simplified"}]},{featureType:"poi",elementType:"all",stylers:[{hue:"#ffffff"},{saturation:-100},{lightness:100},{visibility:"off"}]},{featureType:"road",elementType:"geometry",stylers:[{hue:"#bbc0c4"},{saturation:-93},{lightness:31},{visibility:"simplified"}]},{featureType:"road",elementType:"labels",stylers:[{hue:"#bbc0c4"},{saturation:-93},{lightness:31},{visibility:"on"}]},{featureType:"road.arterial",elementType:"labels",stylers:[{hue:"#bbc0c4"},{saturation:-93},{lightness:-2},{visibility:"simplified"}]},{featureType:"road.local",elementType:"geometry",stylers:[{hue:"#e9ebed"},{saturation:-90},{lightness:-8},{visibility:"simplified"}]},{featureType:"transit",elementType:"all",stylers:[{hue:"#e9ebed"},{saturation:10},{lightness:69},{visibility:"on"}]},{featureType:"water",elementType:"all",stylers:[{hue:"#e9ebed"},{saturation:-78},{lightness:67},{visibility:"simplified"}]}],b=[{featureType:"all",elementType:"all",stylers:[{hue:"#ff0000"},{saturation:-100},{lightness:-30}]},{featureType:"all",elementType:"labels.text.fill",stylers:[{color:"#ffffff"}]},{featureType:"all",elementType:"labels.text.stroke",stylers:[{color:"#353535"}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#656565"}]},{featureType:"poi",elementType:"geometry.fill",stylers:[{color:"#505050"}]},{featureType:"poi",elementType:"geometry.stroke",stylers:[{color:"#808080"}]},{featureType:"road",elementType:"all",stylers:[{color:"#454545"}]},{featureType:"transit",elementType:"labels",stylers:[{hue:"#000000"},{saturation:100},{lightness:-40},{invert_lightness:!0},{gamma:1.5}]}];app.viewModel.lightMode=new google.maps.StyledMapType(a,{name:"Light Mode"}),app.viewModel.darkMode=new google.maps.StyledMapType(b,{name:"Dark Mode"}),app.viewModel.geocoder=new google.maps.Geocoder,app.viewModel.mapOptions={center:{lat:41.90278349999999,lng:12.496365500000024},disableDefaultUI:!0,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,"map_style"]}},app.viewModel.infoWindow=new google.maps.InfoWindow,google.maps.event.addListener(app.viewModel.infoWindow,"closeclick",function(){app.viewModel.toggleMarkerBounce()}),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){var b={lat:a.coords.latitude,lng:a.coords.longitude};app.viewModel.coordinates(b),app.viewModel.mapOptions.center=b,app.viewModel.map=new google.maps.Map(document.getElementById("mapDiv"),app.viewModel.mapOptions),google.maps.event.addDomListener(window,"resize",function(){var a=app.viewModel.map.getCenter();google.maps.event.trigger(app.viewModel.map,"resize"),app.viewModel.map.setCenter(a)}),app.viewModel.initializeTime(),b.lat===b.lng===0?app.viewModel.handleLocationError():app.viewModel.geoLocate(b.lat,b.lng)},function(){app.viewModel.handleLocationError()},{timeout:7500}):app.viewModel.handleLocationError(),app.viewModel.mapBounds=new google.maps.LatLngBounds},mapFallback=function(){app.viewModel.constructAlert({title:"google maps error",details:"There was an error loading the map. Please refresh the page and try again."}),app.viewModel.loading(!1)},ViewModel=function(){function a(){return Math.floor(1e12*Math.random()).toString()}var b=this;this.loading=ko.observable(!0),this.alerting=ko.observable(!0),this.initialSearch=ko.observable(!0),this.alertTitle=ko.observable("geolocation note"),this.alertDetails=ko.observable("For best results enable browser geolocation, or attempt a new search."),this.init=function(){this.configFoursquare(),this.configFlickr(),this.yelp_key_secret="EbOO2hHGytkLpd1lycWv7K-faa4",this.yelp_token_secret="oZEPYCr8TQ2cNaqrDN7_G0ISsis",this.searchTerm=ko.observable("Popular"),this.poi=ko.observable(""),this.rangeVisible=ko.observable(!1),this.coordinates=ko.observable({lat:"",lng:""}),this.latLng=ko.computed(function(){return this.coordinates().lat+","+this.coordinates().lng},this),this.filterQuery=ko.observable(""),this.anchorMarker=ko.observable(),this.venuesArray=ko.observableArray(),this.placesExpanded=ko.observable(!1),this.currentMode=ko.observable(""),this.user=ko.observable(""),this.loggedIn=ko.observable(!1),this.loginExpanded=ko.observable(!1)},this.handleLocationError=function(){$.getJSON("http://freegeoip.net/json/").done(function(a){var c={lat:a.latitude,lng:a.longitude};b.coordinates(c),b.mapOptions.center=c,b.map=new google.maps.Map(document.getElementById("mapDiv"),b.mapOptions),google.maps.event.addDomListener(window,"resize",function(){var a=b.map.getCenter();google.maps.event.trigger(b.map,"resize"),b.map.setCenter(a)}),b.initializeTime(),b.geoLocate(c.lat,c.lng)}).fail(function(a){b.poi("Rome"),b.coordinates({lat:41.90278349999999,lng:12.496365500000024}),b.mapOptions.pos=b.coordinates(),b.map=new google.maps.Map(document.getElementById("mapDiv"),b.mapOptions),b.initializeTime(),google.maps.event.addDomListener(window,"resize",function(){var a=b.map.getCenter();google.maps.event.trigger(b.map,"resize"),b.map.setCenter(a)}),b.constructAlert({title:"geolocation failed",details:"All roads lead to Rome. But for a personalized experience please enable browser geolocation and try again, or attempt a new search."}),b.toggleAlert("open"),b.updateSearch()})},this.getLocalUser=function(){var a=localStorage.user;a?(b.user(a),b.login()):(b.constructAlert({title:"welcome!",details:"Feel free to explore the map, create a user profile, and favorite locations."}),b.toggleAlert("open"))},this.getLastSearch=function(){localStorage.lastPOI,localStorage.lastTerm},this.configFoursquare=function(){this.Foursquare={cID:"AHMKTGNPJOKRI5HSWIQ4GZVRFDXUA2UD4T4ZRBIYRN413QL5",cSecret:"S3D4Y0R1430KP33VNL3MZW320ZFV22YQ2VT02SUX2XCTAD5R",APIbaseURL:"https://api.foursquare.com/",baseVenueURL:"https://foursquare.com/v/",version:"20140601",defaultQuery:ko.observable("topPicks"),radius:ko.observable(1e4)}},this.configFlickr=function(){this.Flickr={key:"&api_key=e3ce05cd3fe0a8e29946f1afa5afc492",secret:"1c5a3dd9614db005",method:"&method=flickr.photos.search",APIbaseURL:"https://api.flickr.com/services/rest/?format=json",sort:"&sort=interestingness-desc",mode:"&jsoncallback=?"}},this.getYelpData=function(c){var d="http://api.yelp.com/v2/phone_search",e={oauth_consumer_key:"cNPz9LqhgDj8zRplQ9P_FQ",oauth_token:"CtUW644wLDpJK0flWMnh2aaZI1outOUw",oauth_nonce:a(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",phone:c.contact.phone,cc:c.location.cc},f=oauthSignature.generate("GET",d,e,b.yelp_key_secret,b.yelp_token_secret);e.oauth_signature=f;var g={url:d,data:e,cache:!0,dataType:"jsonp",success:function(a){var b=a.businesses[0];b&&(c.review(b.snippet_text),c.yelpURL(b.url))},error:function(){b.constructAlert({title:"Yelp error",details:"There was an error with the Yelp API. Some or all of the requested data may be unavailable. Please try again.",delay:3e3}),b.toggleAlert("open")}};$.ajax(g)},this.expandPlaces=function(){b.placesExpanded(!b.placesExpanded())},this.expandRangeOptions=function(){b.rangeVisible(!b.rangeVisible())},this.toggleAlert=function(a,b){"open"===a?this.alerting(!0):this.alerting(!1)},this.constructAlert=function(a){var c=a.delay||0;setTimeout(function(){b.alertTitle(a.title),b.alertDetails(a.details)},c)},this.initializeTime=function(){var a=(new Date).getHours();19>=a&&a>=7?b.currentMode("light"):b.currentMode(""),b.toggleMapMode()},this.updateSearch=function(){if(b.poi()){b.loading(!0);var a=new google.maps.places.PlacesService(b.map),c={query:b.poi()};a.textSearch(c,b.updateLatLng)}else b.constructAlert({title:"invalid search",details:"Please enter a valid location. Specific locations yield accurate results."}),b.toggleAlert("open")},this.updateLatLng=function(a,c){if(c==google.maps.places.PlacesServiceStatus.OK){if(a){var d=a[0].geometry.location;b.coordinates({lat:d.lat(),lng:d.lng()})}}else b.constructAlert({title:"google maps error",details:"There was an issue while discovering the specified location. Please try again."}),b.toggleAlert("open");var e=b.coordinates().lat,f=b.coordinates().lng;b.hideMarkers(),b.venuesArray([]),b.mapBounds=new google.maps.LatLngBounds,b.anchorMarker(new google.maps.Marker({map:b.map,position:{lat:e,lng:f},icon:"img/target.svg",size:new google.maps.Size(3,3),title:"Showing locations near:",animation:google.maps.Animation.DROP})),google.maps.event.addListener(b.anchorMarker(),"click",function(a,c){return function(){c.setContent('<div class="infowindow"><h3 class="infowindow-title">'+b.poi()+"</h3></div>"),c.open(b.map,this),b.map.panTo(a.getPosition()),b.map.setZoom(14)}}(b.anchorMarker(),b.infoWindow)),b.mapBounds.extend(new google.maps.LatLng(e,f)),b.getVenuesData()},this.hideMarkers=function(){var a=b.venuesArray().length;b.anchorMarker()&&(b.anchorMarker().setMap(null),b.anchorMarker(""));for(var c,d=0;a>d;d++)c=b.venuesArray()[d],c.marker.marker.setMap(null)},this.getVenuesData=function(){var a;b.searchTerm()&&"popular"!==b.searchTerm().toLowerCase()?a="&query="+b.searchTerm().split(" ").join("&"):(b.searchTerm("Popular"),a="&section="+b.Foursquare.defaultQuery());var c=b.Foursquare.APIbaseURL+"v2/venues/explore?client_id="+b.Foursquare.cID+"&client_secret="+b.Foursquare.cSecret+"&v="+b.Foursquare.version+a+"&radius="+b.Foursquare.radius()+"&ll="+b.latLng()+"&time=any&day=any&limit=35&venuePhotos=1";$.getJSON(c).done(function(a){var c,d=a.response.groups[0].items;if(d.length)for(var e=0,f=d.length;f>e;e++){c=d[e].venue,c.FoursquareURL=b.Foursquare.baseVenueURL+c.id,c.categories&&c.categories.length||(c.categories=[{name:"Miscellaneous"}]),c.hours||(c.hours={isOpen:!1,status:"Not Available"}),c.rating=parseFloat(c.rating).toFixed(1),"NaN"===c.rating&&(c.rating="--"),c.price||(c.price={tier:0}),c.currentPic=0;var g=c.featuredPhotos;if(g&&g.items.length){var h=g.items[c.currentPic];h.size="250x100",c.photoURL=ko.observable(h.prefix+h.size+h.suffix),c.infowindowPic=c.photoURL()}c.venueVisible=ko.observable(!0),c.venueExpanded=ko.observable(!1),c.favorited=ko.observable(!1),c.review=ko.observable("No Yelp review available."),c.yelpURL=ko.observable(),c.marker=new b.Marker(c),b.venuesArray.push(c)}else b.constructAlert({title:"try another search",details:"Just as with the meaning of life, this search provided no concrete results. Please try a valid search with a specific location for accurate results."}),b.toggleAlert("open"),b.loading(!1);$.ajaxPrefilter(function(a,b,c){a.async=!0}),setTimeout(function(){b.map.fitBounds(b.mapBounds),b.map.setCenter(b.mapBounds.getCenter()),b.orderVenues(),!b.loggedIn()&&b.initialSearch()?(b.myDataRef=new Firebase("https://fendneighborhoodmap.firebaseio.com/"),b.usersRef=b.myDataRef.child("users"),b.venuesRef=b.myDataRef.child("venues"),b.localStorageAvailable=!0,b.getLocalUser(),b.initialSearch(!1)):b.loggedIn()&&b.importUserFavorites(b.loggedInUser);for(var a,c,d=b.venuesArray(),e=0,f=d.length;f>e;e++)a=d[e],c=a.contact.phone,b.getPhotos(a),c&&c.length>9&&b.getYelpData(a);b.loading(!1)},500)}).fail(function(a){b.constructAlert({"this":"foursquare error",details:"There was an error with the Foursquare query. Please try again momentarily, or refine the query."}),b.toggleAlert("open")})},this.orderVenues=function(){var a=b.venuesArray(),c=a.sort(function(a,b){return a.rating>b.rating||"NaN"===b.rating?-1:b.rating>a.rating||"NaN"===a.rating?1:0});b.venuesArray(c)},this.getPhotos=function(a){var c=a.location.lat,d=a.location.lng,e=b.Flickr.APIbaseURL+b.Flickr.key+b.Flickr.method+b.Flickr.sort+b.Flickr.mode+"&lat="+c+"&lon="+d+"&text="+a.name;$.getJSON(e).done(function(b){var c=b.photos.photo;if(c.length){var d,e;c.forEach(function(b){d="https://farm"+b.farm+".staticflickr.com/",e=b.server+"/"+b.id+"_"+b.secret+".jpg",a.featuredPhotos||(a.featuredPhotos={items:[]}),a.featuredPhotos.items.push({prefix:d,suffix:e,size:""})})}}).fail(function(a){b.constructAlert({title:"flickr error",details:"There was a problem harvesting Flickr photos for the venues. Please try again later.",delay:4e3}),b.toggleAlert("open")})},this.Marker=function(a){var c=this;if(this.lat=a.location.lat,this.lng=a.location.lng,this.pos={lat:this.lat,lng:this.lng},this.name=a.name,a&&a.categories&&a.categories[0]&&a.categories[0].icon){this.icon=a.categories[0].icon;var d="bg_";this.size="32";var e=this.icon.prefix,f=this.icon.suffix;this.iconImage=e+d+this.size+f}else this.iconImage="img/question.svg";this.marker=new google.maps.Marker({map:b.map,position:this.pos,icon:this.iconImage,size:new google.maps.Size(5,5),title:this.name,animation:google.maps.Animation.DROP}),this.placeRating=a.rating||"No rating",this.placePrice=new Array(a.price.tier+1).join("$")||"No price";var g=a.infowindowPic||"";g?this.placeImage='<img class="infowindow-img" src='+g+">":this.placeImage=g,this.marker.content='<div class="infowindow"><h3 class="infowindow-title">'+this.name+'</h3><div class="infowindow-pic">'+this.placeImage+'</div><div class="infowindow-info"><h4 class="infowindow-rating">Rating: '+this.placeRating+'</h4><h4 class="infowindow-price">Price: '+this.placePrice+"</h4></div></div>",google.maps.event.addListener(this.marker,"click",function(a,c,d,e){return function(){d.setContent(c.content),d.open(b.map,this),b.map.panTo(c.getPosition()),b.toggleVenueExpand(e),b.toggleMarkerBounce(!0,c)}}(this.marker.content,this.marker,b.infoWindow,a)),b.mapBounds.extend(new google.maps.LatLng(c.lat,c.lng))},this.cyclePics=function(a,b){var c=b.featuredPhotos;if(c&&c.items.length){var d=c.items.length;"backwards"===a?b.currentPic>0?b.currentPic--:b.currentPic=d-1:b.currentPic<d-1?b.currentPic++:b.currentPic=0;var e=c.items[b.currentPic];b.photoURL(e.prefix+e.size+e.suffix)}},this.chooseVenue=function(a,c){for(var d,e=b.venuesArray().length,f=0;e>f;f++)d=b.venuesArray()[f],d.venueExpanded(!1);a.marker.marker.setMap(b.map),b.infoWindow.setContent(a.marker.marker.content),b.toggleMarkerBounce(!0,a.marker.marker),b.infoWindow.open(b.map,a.marker.marker),b.map.setZoom(14),b.map.panTo(a.marker.marker.getPosition())},this.toggleMarkerBounce=function(a,c){for(var d,e=b.venuesArray(),f=0,g=e.length;g>f;f++)d=b.venuesArray()[f],d.marker.marker.setAnimation(null);a&&c.setAnimation(google.maps.Animation.BOUNCE)},this.showAll=function(a){b.infoWindow.close();for(var c,d=b.venuesArray().length,e=0;d>e;e++)c=b.venuesArray()[e],c.venueVisible(!0),c.marker.marker.setMap(b.map),c.venueExpanded(!1);b.map.fitBounds(b.mapBounds)},this.showFavorites=function(a){b.infoWindow.close();var c,d=b.venuesArray().length;if(b.loggedIn()){for(var e=0;d>e;e++)c=b.venuesArray()[e],c.favorited()?c.marker.marker.setMap(b.map):(c.venueVisible(!1),c.marker.marker.setMap(null)),c.venueExpanded(!1);b.map.fitBounds(b.mapBounds)}else b.constructAlert({title:"no favorites yet",details:"You must create a new user profile or be logged in to use this feature."}),b.toggleAlert("open")},this.geoLocate=function(a,c){var d;"number"==typeof a&&"number"==typeof c?(d=new google.maps.LatLng(a,c),b.geocoder?b.geocoder.geocode({latLng:d},function(a,c){c==google.maps.GeocoderStatus.OK?b.getLocations(a):(b.constructAlert({title:"google maps error",details:"There was an issue while discovering the specified location. Please try again."}),b.toggleAlert("open"))}):(b.constructAlert({title:"google maps error",details:"There was an error with the map. Please refresh the page and try again."}),b.toggleAlert("open"))):navigator.geolocation.getCurrentPosition(function(a){d=new google.maps.LatLng(a.coords.latitude,a.coords.longitude),b.geocoder?b.geocoder.geocode({latLng:d},function(a,c){c==google.maps.GeocoderStatus.OK?(b.poi(a[0].address_components[2].long_name),b.coordinates({lat:d.lat(),lng:d.lng()}),b.loading(!0),b.updateLatLng("",c)):(b.constructAlert({title:"google maps error",details:"There was an issue while discovering the specified location. Please try again."}),b.toggleAlert("open"))}):(b.constructAlert({title:"google maps error",details:"There was an error with the map. Please refresh the page and try again."}),b.toggleAlert("open"))},b.handleLocationError)},this.getLocations=function(a){b.hideMarkers();var c=b.coordinates().lat,d=b.coordinates().lng;b.anchorMarker()&&(b.anchorMarker().setMap(null),b.anchorMarker("")),b.anchorMarker(new google.maps.Marker({map:b.map,position:{lat:c,lng:d},icon:"img/target.svg",title:"Showing locations near:",size:new google.maps.Size(3,3)})),google.maps.event.addListener(b.anchorMarker(),"click",function(a,c){return function(){c.setContent('<div class="infowindow"><h3 class="infowindow-title">'+b.poi()+"</h3></div>"),c.open(b.map,this),b.map.panTo(a.getPosition()),b.map.setZoom(14)}}(b.anchorMarker(),b.infoWindow)),b.mapBounds=new google.maps.LatLngBounds,b.mapBounds.extend(new google.maps.LatLng(c,d)),b.poi(a[0].address_components[2].long_name),b.getVenuesData()},this.toggleMapMode=function(){"light"===b.currentMode()?(b.map.mapTypes.set("map_style",this.lightMode),b.map.setMapTypeId("map_style"),b.currentMode("")):(b.map.mapTypes.set("map_style",this.darkMode),b.map.setMapTypeId("map_style"),b.currentMode("light"))},this.filterVenues=function(){for(var a,c=this.venuesArray().length,d=this.filterQuery().toLowerCase(),e=0;c>e;e++){var f=this.venuesArray()[e];a=f.name.toLowerCase(),a.indexOf(d)>=0?(f.venueVisible(!0),f.marker.marker.setMap(b.map)):(f.venueVisible(!1),f.marker.marker.setMap(null))}},this.toggleVenueExpand=function(a,c){var d,e=b.venuesArray().length;if(a.venueExpanded())b.infoWindow.close(),b.toggleMarkerBounce();else{for(var f=0;e>f;f++)d=b.venuesArray()[f],d.venueExpanded(!1);b.chooseVenue(a,c)}a.venueExpanded(!a.venueExpanded())},this.toggleLogin=function(){this.loginExpanded(!this.loginExpanded())},this.contains=function(a,b){for(var c=!1,d=0,e=b.length;e>d;d++)a.indexOf(b.charAt(d))>-1&&(c=!0);return c},this.login=function(){var a="users/"+b.user(),c=b.user();c&&!b.contains(c," .#$[]")?this.myDataRef.child(a).once("value",function(a){var d=a.val();if(d)b.constructAlert({title:"welcome back, "+c,details:"You are logged in. Feel free to explore and favorite any locations you find enjoyable.",delay:5500}),b.toggleAlert("open"),b.importUserFavorites(c);else{var e={};e[c]="No favorites yet.",b.usersRef.update(e,function(a){a?(b.constructAlert({title:"login error",details:"The user profile could not be created at this time. Please try again later.",delay:5500}),b.toggleAlert("open")):(b.constructAlert({title:"welcome, "+c,details:"The user profile was successfully created. Feel free to explore and favorite any locations around the world you find enjoyable.",delay:5500}),b.toggleAlert("open"))})}b.loggedIn(!0),b.loggedInUser=b.user(),b.localStorageAvailable&&(localStorage.user=c)},function(a){a&&(b.constructAlert({title:"database error",details:"There was an error contacting the database. Please check the connection and try again."}),b.toggleAlert("open"))}):(b.constructAlert({title:"user error",details:'Please use a valid name. Paths must be non-empty strings, not containing the following characters: ". # $ [ ]".'}),b.toggleAlert("open"))},this.toggleVenueFavorite=function(a){b.loggedIn()?b.checkUserFavorites(b.loggedInUser,a,"favorite"):(b.constructAlert({title:"login required",details:"Please login or create a user profile first, and try again."}),b.toggleAlert("open"))},this.favoriteVenue=function(a,c){var d=b.loggedInUser;if(a)c.favorited(!1);else{var e={};e.id=c.id,b.usersRef.child(d).push().update(e,function(a){a?(b.constructAlertTitle({title:"database error",details:"There was an error while handling user favorites. Please try again later."}),b.toggleAlert()):c.favorited(!0)})}},this.checkUserFavorites=function(a,c,d){this.usersRef.child(a).once("value",function(a){var e,f,g,h,i=c.id,j=a.numChildren();j?(h=a.forEach(function(a){e=a.val(),g=a.key(),f=e.id;var h=f===i;return h?(b.userAction(h,c,d,g,j),h):void 0}),h||b.userAction(h,c,d)):b.userAction(h,c,d)},function(a){a&&(b.constructAlert({title:"database error",details:"There was an error contacting the database. Please check the connection and try again."}),b.toggleAlert("open"))})},this.userAction=function(a,c,d,e,f){var g=b.loggedInUser;switch(d){case"favorite":if(a){var h=g+"/"+e;if(f>1)b.usersRef.child(h).remove(function(a){a&&(b.constructAlert({title:"database error",details:"There was an error contacting the database. Please check the connection and try again."}),b.toggleAlert("open"))}),c.favorited(!1);else{var i={};i[g]="No favorites yet.",b.usersRef.update(i,function(a){a&&(b.constructAlert({title:"favorite error",details:"There was an error in saving the user favorite. Please try again later."}),b.toggleAlert("open"))})}c.favorited(!1)}else b.favoriteVenue(a,c),c.favorited(!0);break;case"import":a?c.favorited(!0):c.favorited(!1)}},this.importUserFavorites=function(a){for(var c,d=b.venuesArray(),e=0,f=d.length;f>e;e++)c=d[e],b.checkUserFavorites(a,c,"import")},this.init()};app.viewModel=new ViewModel,ko.applyBindings(app.viewModel);