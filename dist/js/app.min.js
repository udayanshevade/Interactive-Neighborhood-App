var app=app||{};!function(){app.animateRoute=function(a,b,c){var d,e,f,g,h,i=c||{},j=0,k=i.steps||20,l=i.speed||.5,m=b.animationIndex,n=b.animationIndex+1;if(n>=a.length)return clearInterval(h),!1;d=a[m],e=a[n];var o=i.polylineOptions||{strokeColor:"#50bfe6",strokeOpacity:1,strokeWeight:5};o.map=app.map,o.path=[d,d],g=new google.maps.Polyline(o),b.renderedPaths.push(g),h=setInterval(function(){j++,j>k?(b.animationIndex++,app.animateRoute(a,b,c),clearInterval(h)):(f=google.maps.geometry.spherical.interpolate(d,e,j/k),g.setPath([d,f]))},l)}}();var app=app||{};!function(){app.filters={GDPeuker:function(a){var b=GDouglasPeuker(a.map(function(a){return a.googLatLng})),c=a.filter(function(a){return b.indexOf(a.googLatLng)>-1});return c},maxDistanceTravelled:function(a){var b,c,d,e=13,f=[];for(b=0;b<a.length;b++){if(c=a[b],d){var g=c.timestamp-d.timestamp,h=g*e,i=google.maps.geometry.spherical.computeDistanceBetween(d.googLatLng,c.googLatLng);if(i>h)continue;f.push(c)}else f.push(c);d=c}return f}}}();var app=app||{};!function(){app.initializeMap=function(){function a(a){var b=[{featureType:"administrative.locality",elementType:"all",stylers:[{hue:"#2c2e33"},{saturation:7},{lightness:19},{visibility:"on"}]},{featureType:"landscape",elementType:"all",stylers:[{hue:"#ffffff"},{saturation:-100},{lightness:100},{visibility:"simplified"}]},{featureType:"poi",elementType:"all",stylers:[{hue:"#ffffff"},{saturation:-100},{lightness:100},{visibility:"off"}]},{featureType:"road",elementType:"geometry",stylers:[{hue:"#bbc0c4"},{saturation:-93},{lightness:31},{visibility:"simplified"}]},{featureType:"road",elementType:"labels",stylers:[{hue:"#bbc0c4"},{saturation:-93},{lightness:31},{visibility:"on"}]},{featureType:"road.arterial",elementType:"labels",stylers:[{hue:"#bbc0c4"},{saturation:-93},{lightness:-2},{visibility:"simplified"}]},{featureType:"road.local",elementType:"geometry",stylers:[{hue:"#e9ebed"},{saturation:-90},{lightness:-8},{visibility:"simplified"}]},{featureType:"transit",elementType:"all",stylers:[{hue:"#e9ebed"},{saturation:10},{lightness:69},{visibility:"on"}]},{featureType:"water",elementType:"all",stylers:[{hue:"#e9ebed"},{saturation:-78},{lightness:67},{visibility:"simplified"}]}],c=[{featureType:"all",elementType:"labels",stylers:[{visibility:"on"}]},{featureType:"all",elementType:"labels.text.fill",stylers:[{saturation:36},{color:"#000000"},{lightness:40}]},{featureType:"all",elementType:"labels.text.stroke",stylers:[{visibility:"on"},{color:"#000000"},{lightness:16}]},{featureType:"all",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"administrative",elementType:"geometry.fill",stylers:[{color:"#000000"},{lightness:20}]},{featureType:"administrative",elementType:"geometry.stroke",stylers:[{color:"#000000"},{lightness:17},{weight:1.2}]},{featureType:"administrative.country",elementType:"labels.text.fill",stylers:[{color:"#e5c163"}]},{featureType:"administrative.locality",elementType:"labels.text.fill",stylers:[{color:"#c4c4c4"}]},{featureType:"administrative.neighborhood",elementType:"labels.text.fill",stylers:[{color:"#e5c163"}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#000000"},{lightness:20}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#000000"},{lightness:21},{visibility:"on"}]},{featureType:"poi.business",elementType:"geometry",stylers:[{visibility:"on"}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#e5c163"},{lightness:"0"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{visibility:"off"}]},{featureType:"road.highway",elementType:"labels.text.fill",stylers:[{color:"#ffffff"}]},{featureType:"road.highway",elementType:"labels.text.stroke",stylers:[{color:"#e5c163"}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#000000"},{lightness:18}]},{featureType:"road.arterial",elementType:"geometry.fill",stylers:[{color:"#575757"}]},{featureType:"road.arterial",elementType:"labels.text.fill",stylers:[{color:"#ffffff"}]},{featureType:"road.arterial",elementType:"labels.text.stroke",stylers:[{color:"#2c2c2c"}]},{featureType:"road.local",elementType:"geometry",stylers:[{color:"#000000"},{lightness:16}]},{featureType:"road.local",elementType:"labels.text.fill",stylers:[{color:"#999999"}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#000000"},{lightness:19}]},{featureType:"water",elementType:"geometry",stylers:[{color:"#000000"},{lightness:17}]}];app.anchorInfowindowTimeout="",app.lightMode=new google.maps.StyledMapType(b,{name:"Light Mode"}),app.lightIcon="img/target_light.svg",app.darkMode=new google.maps.StyledMapType(c,{name:"Dark Mode"}),app.darkIcon="img/target_dark.svg",app.geocoder=new google.maps.Geocoder,app.directionsRenderer=new google.maps.DirectionsRenderer,app.directionsRenderer.setPanel(document.getElementById("directions-panel")),app.mapOptions={center:{lat:41.90278349999999,lng:12.496365500000024},disableDefaultUI:!0,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,"map_style"]}},navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){var c={lat:b.coords.latitude,lng:b.coords.longitude};app.viewModel.coordinates(c),app.mapOptions.center=c,app.map=new google.maps.Map(document.getElementById("mapDiv"),app.mapOptions),google.maps.event.addListener(app.map,"click",function(){app.viewModel.loginExpanded()&&app.viewModel.toggleLogin(!1),app.viewModel.directionsExpanded()&&app.viewModel.toggleDirections(!1)}),a?(app.infoWindow=new InfoBox({disableAutoPan:!1,pixelOffset:new google.maps.Size((-140),(-24)),zIndex:null,alignBottom:!0,boxStyle:{background:"white",width:"280px","box-radius":"2px","box-shadow":"1px 2px 6px rgba(0, 0, 0, 0.3)"},closeBoxURL:"",infoBoxClearance:new google.maps.Size(1,1),isHidden:!1,pane:"floatPane",enableEventPropagation:!1}),google.maps.event.addListener(app.infoWindow,"domready",function(){$(".infoBox").addClass("entering"),$(".infowindow-close-button").click(function(){app.viewModel.toggleVenueExpand(app.viewModel.selected())})})):app.infoWindow=new google.maps.InfoWindow,google.maps.event.addListener(app.infoWindow,"closeclick",function(){$(".infoBox").toggleClass("entering leaving");var a=app.viewModel.selected();app.viewModel.toggleVenueExpand(a)}),google.maps.event.addDomListener(window,"resize",function(){var a=app.map.getCenter();google.maps.event.trigger(app.map,"resize"),app.map.setCenter(a),app.mapBounds&&app.map.fitBounds(app.mapBounds)}),app.viewModel.initializeTime(),c.lat===c.lng===0?app.handleLocationError():app.geoLocate(c.lat,c.lng)},function(){app.handleLocationError()},{timeout:7500}):app.handleLocationError(),app.mapBounds=new google.maps.LatLngBounds}$.getScript("lib/infobox/infobox.js").done(function(){a(!0)}).fail(function(){a(!1)}),$.getScript("js/animation.js").done(function(){$.getScript("js/filters.js").done(function(){$.getScript("js/route.js").done(function(){app.viewModel.animatedDirectionsAvailable(!0)})})})},app.mapFallback=function(){app.viewModel.constructAlert({title:"google maps error",details:"There was an error loading the map. Please refresh the page and try again."}),app.viewModel.loading(!1)},app.geoLocate=function(a,b){var c;app.viewModel.loading(!0),"number"==typeof a&&"number"==typeof b?(c=new google.maps.LatLng(a,b),app.geocoder?app.geocoder.geocode({latLng:c},function(a,b){b==google.maps.GeocoderStatus.OK?app.viewModel.getLocations(a):app.viewModel.newAlert({title:"google maps error",details:"There was an issue while discovering the specified location. Please try again."})}):app.viewModel.newAlert({title:"google maps error",details:"There was an error with the map. Please refresh the page and try again."})):navigator.geolocation.getCurrentPosition(function(a){c=new google.maps.LatLng(a.coords.latitude,a.coords.longitude),app.geocoder?app.geocoder.geocode({latLng:c},function(a,b){b==google.maps.GeocoderStatus.OK?(app.viewModel.poi(a[0].address_components[2].long_name),app.viewModel.coordinates({lat:c.lat(),lng:c.lng()}),app.viewModel.loading(!0),app.updateLatLng("",b)):app.viewModel.newAlert({title:"google maps error",details:"There was an issue while discovering the specified location. Please try again."})}):app.viewModel.newAlert({title:"google maps error",details:"There was an error with the map. Please refresh the page and try again."})},app.viewModel.handleLocationError)},app.handleLocationError=function(){$.getJSON("https://freegeoip.net/json/").done(function(a){var b={lat:a.latitude,lng:a.longitude};app.viewModel.coordinates(b),app.mapOptions.center=b,app.map=new google.maps.Map(document.getElementById("mapDiv"),app.mapOptions),google.maps.event.addDomListener(window,"resize",function(){var a=app.map.getCenter();google.maps.event.trigger(app.map,"resize"),app.map.setCenter(a)}),app.viewModel.initializeTime(),app.geoLocate(b.lat,b.lng)}).fail(function(a){app.viewModel.poi("Rome"),app.viewModel.coordinates({lat:41.90278349999999,lng:12.496365500000024}),app.mapOptions.pos=app.viewModel.coordinates(),app.map=new google.maps.Map(document.getElementById("mapDiv"),app.mapOptions),app.viewModel.initializeTime(),google.maps.event.addDomListener(window,"resize",function(){var a=app.map.getCenter();google.maps.event.trigger(app.map,"resize"),app.map.setCenter(a)}),app.viewModel.newAlert({title:"geolocation failed",details:"All roads lead to Rome. But for a personalized experience please enable browser geolocation and try again, or attempt a new search."}),app.viewModel.updateSearch()})},app.updateLatLng=function(a,b){if(b==google.maps.places.PlacesServiceStatus.OK){if(a){var c=a[0].geometry.location;app.viewModel.coordinates({lat:c.lat(),lng:c.lng()})}}else app.viewModel.newAlert({title:"google maps error",details:"There was an issue while discovering the specified location. Please try again."});var d=app.viewModel.coordinates().lat,e=app.viewModel.coordinates().lng;app.viewModel.hideMarkersAndPaths(),app.mapBounds=new google.maps.LatLngBounds,app.viewModel.anchorMarker(new google.maps.Marker({map:app.map,position:{lat:d,lng:e},icon:app.viewModel.currentMode()?app.lightIcon:app.darkIcon,size:new google.maps.Size(5,5),title:"Showing locations near:",animation:google.maps.Animation.DROP})),google.maps.event.addListener(app.viewModel.anchorMarker(),"click",function(a,b){return function(){app.anchorInfowindowTimeout&&clearTimeout(app.anchorInfowindowTimeout),app.viewModel.selected()&&app.viewModel.toggleVenueExpand(app.viewModel.selected()),b.setContent('<div class="infowindow"><div class="infowindow-content"><h3 class="infowindow-title">'+app.viewModel.poi()+"</h3></div></div>"),b.open(app.map,this),app.anchorInfowindowTimeout=setTimeout(function(){app.viewModel.closeInfoWindow()},3e3),app.map.panTo(a.getPosition()),app.map.panBy(0,-75),app.map.setZoom(12)}}(app.viewModel.anchorMarker(),app.infoWindow)),app.mapBounds.extend(new google.maps.LatLng(d,e)),app.viewModel.getVenuesData()}}();var app=app||{};!function(){app.Route=function(a){this.options=this.extend(this._options,a),this.init()},app.Route.prototype={_options:{initializeFilters:!0,animate:!1},enabledFilters:{},init:function(){this.enabledFilters=this.options.initializeFilters?app.filters:{},this.animationIndex=0,this.renderedPaths=[],this.line={},this.coordinates=[],this.parseJSON(this._options.points)},parseJSON:function(a){this.coordinates=a.map(function(a){return{lat:a.lat(),lng:a.lng(),googLatLng:new google.maps.LatLng(a.lat(),a.lng())}})},updateRoutes:function(a){var b=this.normalizeCoordinates().map(function(a){return a.googLatLng});return this.options.animate?(this.enabledFilters=app.filters,b=this.normalizeCoordinates().map(function(a){return a.googLatLng}),void app.animateRoute(b,this,a)):(this.line=new gmaps.Polyline({path:b,strokeColor:"#50bfe6",strokeOpacity:1,strokeWeight:5}),void this.line.setMap(this.map))},normalizeCoordinates:function(){var a=this,b=Object.keys(a.enabledFilters);return b.reduce(function(b,c){return a.enabledFilters[c](b)},a.coordinates)},hide:function(){this.animationIndex=0,this.renderedPaths.forEach(function(a){a.setMap(null)}),this.renderedPaths=[]},render:function(a){this.line.setMap&&this.line.setMap(null),this.options.animate=!0,this.updateRoutes(a)},styleLine:function(a){if(this.renderedPaths&&this.renderedPaths.length){var b=Object.keys(a);this.renderedPaths.forEach(function(c){b.forEach(function(b){c.setOptions({property:a[b]})})})}},extend:function(a,b){return Object.keys(b).forEach(function(c){a[c]=b[c]}),a}}}();var app=app||{};!function(){var a=function(){function a(){return Math.floor(1e12*Math.random()).toString()}var b=this;this.startUp=function(){this.loading=ko.observable(!0),this.initialSearch=ko.observable(!0),this.animatedDirectionsAvailable=ko.observable(!1),this.initializeAlerts()},this.initializeAlerts=function(){this.alerting=ko.observable(!0),this.alerts=ko.observableArray([]),this.alerts.push({title:"geolocation note",details:"For best results enable browser geolocation, or attempt a new search."}),this.currentAlert=ko.computed(function(){var a=this.alerts();if(a.length)return a[0]},this)},this.startUp();var c=function(a){var c=a.venue,d=a.tips;this.FoursquareURL=b.Foursquare.baseVenueURL+c.id,this.name=c.name,this.domID=c.name.toLowerCase().split(" ").join("-").replace(/[^a-zA-Z0-9-]/g,""),this.location=c.location,this.id=c.id,this.setCategories(c.categories),this.setHours(c.hours),this.setRating(c.rating),this.setPrice(c.price),this.contact=c.contact,this.url=c.url,this.review=ko.observable(""),this.yelpURL=ko.observable(),this.setPhone(this.contact.phone),this.photoURL=ko.observable(""),this.setPhotos(c.featuredPhotos),this.multiPhotos=ko.observable(!1),this.venueVisible=ko.observable(!0),this.venueExpanded=ko.observable(!1),this.favorited=ko.observable(!1),this.setTip(d),this.marker=new b.Marker(this),this.directionActive=ko.observable(!1),this.directionFetched=ko.observable(!1)};c.prototype.setCategories=function(a){this.categories=a&&a.length?a:[{name:"Miscellaneous "}]},c.prototype.setHours=function(a){this.hours=a?a:{isOpen:null,status:"Hours not available"}},c.prototype.setRating=function(a){a=parseFloat(a).toFixed(1),this.rating="NaN"===a?"--":a},c.prototype.setPrice=function(a){this.price=a?a:{tier:0}},c.prototype.setPhone=function(a){a&&10===a.length&&this.review("Loading Yelp review...")},c.prototype.setPhotos=function(a){if(this.currentPic=0,a&&a.items.length){var b=a.items[this.currentPic];b.size="250x100",this.photoURL(b.prefix+b.size+b.suffix),this.infowindowPic=this.photoURL()}},c.prototype.setTip=function(a){this.tip=ko.observable(),a&&a.length||this.tip(null);var b=a[0];this.tip({text:b.text,agree:b.agreeCount,img:b.photo?b.photo.prefix+b.photo.suffix:""})},this.init=function(){this.configFoursquare(),this.configFlickr(),this.yelpKeySecret="EbOO2hHGytkLpd1lycWv7K-faa4",this.yelpTokenSecret="oZEPYCr8TQ2cNaqrDN7_G0ISsis",this.initializeObservables()},this.initializeObservables=function(){this.searchTerm=ko.observable("Popular"),this.venuesArray=ko.observableArray(),this.filterQuery=ko.observable(""),this.favoritesOnly=ko.observable(!1),this.filteredVenuesArray=ko.computed(function(){var a=this.venuesArray(),b=(a.length,this.filterQuery().toLowerCase()),c=this.favoritesOnly();return a.filter(function(a){var d=a.favorited(),e=a.name.toLowerCase(),f=e.indexOf(b)>-1,g=f&&(!c||d),h=a.marker.marker.getMap()===app.map;return g!==h&&a.marker.marker.setMap(g?app.map:null),g})},this),this.poi=ko.observable(""),this.rangeVisible=ko.observable(!1),this.coordinates=ko.observable({lat:"",lng:""}),this.latLng=ko.computed(function(){return this.coordinates().lat+","+this.coordinates().lng},this),this.anchorMarker=ko.observable(),this.placesExpanded=ko.observable(!1),this.filterExpanded=ko.observable(!0),this.currentMode=ko.observable(""),this.user=ko.observable(""),this.currentUser=ko.observable(""),this.loggedIn=ko.observable(!1),this.loginExpanded=ko.observable(!1),this.selected=ko.observable(null),this.shouldScroll=ko.observable(!1),this.directionsExpanded=ko.observable(!1),this.directionsTip=ko.observable("Select a location to see its directions.")},this.initializeDatabase=function(){b.myDataRef=new Firebase("https://fendneighborhoodmap.firebaseio.com/"),b.usersRef=b.myDataRef.child("users"),b.venuesRef=b.myDataRef.child("venues")},this.getLocalUser=function(){var a=localStorage.user;a?(b.user(a),b.login()):b.newAlert({title:"welcome!",details:"Feel free to explore the map, create a user profile, and favorite locations."})},this.getLastSearch=function(){localStorage.lastPOI,localStorage.lastTerm},this.configFoursquare=function(){this.Foursquare={cID:"AHMKTGNPJOKRI5HSWIQ4GZVRFDXUA2UD4T4ZRBIYRN413QL5",cSecret:"S3D4Y0R1430KP33VNL3MZW320ZFV22YQ2VT02SUX2XCTAD5R",APIbaseURL:"https://api.foursquare.com/",baseVenueURL:"https://foursquare.com/v/",version:"20140601",defaultQuery:ko.observable("topPicks"),radius:ko.observable(1e4)}},this.configFlickr=function(){this.Flickr={key:"&api_key=e3ce05cd3fe0a8e29946f1afa5afc492",secret:"1c5a3dd9614db005",method:"&method=flickr.photos.search",APIbaseURL:"https://api.flickr.com/services/rest/?format=json",sort:"&sort=interestingness-desc",mode:"&nojsoncallback=1"}},this.getYelpParams=function(b){return{oauth_consumer_key:"cNPz9LqhgDj8zRplQ9P_FQ",oauth_token:"CtUW644wLDpJK0flWMnh2aaZI1outOUw",oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",oauth_nonce:a(),oauth_timestamp:Math.floor(Date.now()/1e3),phone:b}},this.getYelpData=function(a){var c="https://api.yelp.com/v2/phone_search",d=this.getYelpParams(a.contact.phone),e=oauthSignature.generate("GET",c,d,b.yelpKeySecret,b.yelpTokenSecret);d.oauth_signature=e;var f={url:c,data:d,cache:!0,dataType:"jsonp"};$.ajax(f).done(function(b){var c=b.businesses[0],d="";c&&(d=c.snippet_text,a.yelpURL(c.url)),a.review(d)}).fail(function(a){b.newAlert({title:"Yelp error",details:"There was an error with the Yelp API. Some requested data may be unavailable at this time. Please try again.",duration:2e3})})},this.expandPlaces=function(){this.placesExpanded(!this.placesExpanded()),this.shouldScroll()&&(this.shouldScroll(!1),this.scrollToLocation(this.selected().domID))},this.expandRangeOptions=function(){b.rangeVisible(!b.rangeVisible())},this.toggleAlert=function(a){"open"===a?this.alerting(!0):this.alerting(!1)},this.closeAlerts=function(){this.toggleAlert(),this.alerts.removeAll()},this.newAlert=function(a){var b=this.alerts().some(function(b){return b.title===a.title});b||(this.alerts.push(a),this.toggleAlert("open"))},this.getNextAlert=function(){this.alerts();this.alerts.shift()},this.initializeTime=function(){var a=(new Date).getHours();a<=19&&a>=7?b.currentMode("dark"):b.currentMode(""),b.toggleMapMode()},this.updateSearch=function(){if(b.poi()){b.loading(!0);var a=new google.maps.places.PlacesService(app.map),c={query:b.poi()};a.textSearch(c,app.updateLatLng)}else b.newAlert({title:"invalid search",details:"Please enter a valid location. Specific locations yield accurate results."})},this.hideMarkersAndPaths=function(){b.anchorMarker()&&(b.anchorMarker().setMap(null),b.anchorMarker(null));for(var a,c=b.venuesArray(),d=c.length,e=0;e<d;e++)a=c[e],a.route&&a.route.hide(),a.marker.marker.setMap(null),a.marker.marker=null},this.emptyVenuesData=function(){b.venuesArray().forEach(function(){}),b.venuesArray([])},this.getVenuesData=function(){b.emptyVenuesData();var a;b.searchTerm()&&"popular"!==b.searchTerm().toLowerCase()?a="&query="+b.searchTerm().split(" ").join("&"):(b.searchTerm("Popular"),a="&section="+b.Foursquare.defaultQuery());var d=b.Foursquare.APIbaseURL+"v2/venues/explore?client_id="+b.Foursquare.cID+"&client_secret="+b.Foursquare.cSecret+"&v="+b.Foursquare.version+a+"&radius="+b.Foursquare.radius()+"&ll="+b.latLng()+"&time=any&day=any&limit=35&venuePhotos=1";$.getJSON(d).done(function(a){var d=a.response.groups[0].items;if(d.length)for(var e=0,f=d.length;e<f;e++)venueData=d[e],b.venuesArray.push(new c(venueData));else b.newAlert({title:"try another search",details:"Just as with the meaning of life, this search provided no concrete results. Please try a valid search with a specific location for accurate results."}),b.loading(!1);setTimeout(function(){app.map.fitBounds(app.mapBounds),app.map.setCenter(app.mapBounds.getCenter()),app.map.setZoom(14),b.orderVenues(),b.showDirections(),!b.loggedIn()&&b.initialSearch()?(b.localStorageAvailable=!0,b.getLocalUser(),b.initialSearch(!1)):b.loggedIn()&&b.importUserFavorites(b.loggedInUser);for(var a,c,d=b.venuesArray(),e=0,f=d.length;e<f;e++)a=d[e],a.directionsService=new google.maps.DirectionsService,c=a.contact.phone,b.getPhotos(a),c&&10===c.length&&b.getYelpData(a);b.loading(!1),new google.maps.event.trigger(b.anchorMarker(),"click")},500)}).fail(function(a){b.newAlert({"this":"foursquare error",details:"There was an error with the Foursquare query. Please try again momentarily, or refine the query."})})},this.orderVenues=function(){var a=b.venuesArray(),c=a.sort(function(a,b){return a.rating>b.rating||"NaN"===b.rating?-1:b.rating>a.rating||"NaN"===a.rating?1:0});b.venuesArray(c)},this.getPhotos=function(a){var c=a.location.lat,d=a.location.lng,e=b.Flickr.APIbaseURL+b.Flickr.key+b.Flickr.method+b.Flickr.mode+b.Flickr.sort+"&lat="+c+"&lon="+d+"&text="+a.name;$.getJSON(e).done(function(b){var c=b.photos.photo;if(c.length){var d,e;c.forEach(function(b){d="https://farm"+b.farm+".staticflickr.com/",e=b.server+"/"+b.id+"_"+b.secret+".jpg",a.featuredPhotos||(a.featuredPhotos={items:[]}),a.featuredPhotos.items.push({prefix:d,suffix:e,size:""})}),a.multiPhotos(a.featuredPhotos.items.length>1)}}).fail(function(a){b.newAlert({title:"flickr error",details:"There was a problem harvesting Flickr photos for the venues. Please try again later.",duration:3e3})})},this.Marker=function(a){var c=this;if(this.lat=a.location.lat,this.lng=a.location.lng,this.pos={lat:this.lat,lng:this.lng},this.name=a.name,a&&a.categories&&a.categories[0]&&a.categories[0].icon){this.icon=a.categories[0].icon;var d="bg_";this.size="32";var e=this.icon.prefix,f=this.icon.suffix;this.iconImage=e+d+this.size+f}else this.iconImage="img/question.svg";this.marker=new google.maps.Marker({map:app.map,position:this.pos,icon:this.iconImage,size:new google.maps.Size(5,5),title:this.name,animation:google.maps.Animation.DROP}),this.placeRating=a.rating||"No rating",this.placePrice=new Array(a.price.tier+1).join("$")||"No price";a.infowindowPic||"";google.maps.event.addListener(this.marker,"click",function(a){return function(){b.toggleVenueExpand(a)}}(a)),app.mapBounds.extend(new google.maps.LatLng(c.lat,c.lng))},this.cyclePics=function(a,b){var c=b.featuredPhotos;if(c&&c.items.length){var d=c.items.length;"backwards"===a?b.currentPic>0?b.currentPic--:b.currentPic=d-1:b.currentPic<d-1?b.currentPic++:b.currentPic=0;var e=c.items[b.currentPic];b.photoURL(e.prefix+e.size+e.suffix)}},this.chooseVenue=function(a){app.anchorInfowindowTimeout&&clearTimeout(app.anchorInfowindowTimeout),this.placesExpanded()?this.scrollToLocation(a.domID):this.shouldScroll(!0);var c=this.selected();if(c&&(c.venueExpanded(!1),c.route.styleLine({strokeOpacity:.4})),this.selected(a),a.marker.marker.setMap(app.map),app.infoWindow.setContent($("#infowindow-template").html()),this.toggleMarkerBounce(!0,a.marker.marker),app.infoWindow.open(app.map,a.marker.marker),app.map.panTo(a.marker.marker.getPosition()),app.map.panBy(0,-75),a.directionFetched())app.directionsRenderer.setDirections(a.directionData),a.route.styleLine({strokeOpacity:.4}),this.directionsTip(null);else{var d=a.directionFetched.subscribe(function(){app.directionsRenderer.setDirections(b.selected().directionData),a.route.styleLine({strokeOpacity:1}),b.directionsTip(null),d.dispose(),d=null});this.directionsTip("Loading directions..."),this.showDirection(a)}},this.toggleMarkerBounce=function(a,b){a&&(b.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){b.setAnimation(null)},1500))},this.showAll=function(a){this.filterQuery(""),this.favoritesOnly(!1),app.map.fitBounds(app.mapBounds)},this.showFavorites=function(a){this.loggedIn()?this.favoritesOnly(!0):this.newAlert({title:"no favorites yet",details:"You must create a new user profile or be logged in to use this feature."})},this.geoLocate=function(a,b){app.geoLocate(a,b)},this.getLocations=function(a){this.hideMarkersAndPaths();var c=this.coordinates().lat,d=this.coordinates().lng;this.anchorMarker()&&(this.anchorMarker().setMap(null),this.anchorMarker(null)),this.anchorMarker(new google.maps.Marker({map:app.map,position:{lat:c,lng:d},icon:b.currentMode()?app.lightIcon:app.darkIcon,title:"Showing locations near:",size:new google.maps.Size(5,5)})),google.maps.event.addListener(this.anchorMarker(),"click",function(a,c){return function(){app.anchorInfowindowTimeout&&clearTimeout(app.anchorInfowindowTimeout),b.selected()&&b.toggleVenueExpand(b.selected()),c.setContent('<div class="infowindow"><div class="infowindow-content"><h3 class="infowindow-title">'+b.poi()+"</h3></div></div>"),c.open(app.map,this),app.anchorInfowindowTimeout=setTimeout(function(){b.closeInfoWindow()},3e3),app.map.panTo(a.getPosition()),app.map.panBy(0,-75)}}(this.anchorMarker(),app.infoWindow)),app.mapBounds=new google.maps.LatLngBounds,app.mapBounds.extend(new google.maps.LatLng(c,d)),this.poi(a[0].address_components[2].long_name),this.getVenuesData()},this.toggleFilterExpanded=function(a){"boolean"==typeof a?this.filterExpanded(a):this.filterExpanded(!this.filterExpanded())},this.toggleMapMode=function(){this.currentMode()?(this.anchorMarker()&&this.anchorMarker().setIcon(app.darkIcon),app.map.mapTypes.set("map_style",app.lightMode),app.map.setMapTypeId("map_style"),this.currentMode("")):(this.anchorMarker()&&this.anchorMarker().setIcon(app.lightIcon),app.map.mapTypes.set("map_style",app.darkMode),app.map.setMapTypeId("map_style"),this.currentMode("dark"))},this.toggleVenueExpand=function(a,c){a.venueExpanded()?(b.closeInfoWindow(),b.toggleMarkerBounce(!1,a.marker.marker),b.scrollToLocation(),b.selected(null),b.directionsTip("Select a venue to see its directions."),b.shouldScroll(!1)):(b.selected()&&b.selected().venueExpanded(!1),b.chooseVenue(a,c)),a.venueExpanded(!a.venueExpanded())},this.scrollToLocation=function(a,b){var c=document.getElementById("places-list-section"),e=135,f=a?document.getElementById(a).offsetTop-e:null,g=500;f&&f<0&&(f=0),d(c,f,g)};var d=function(a,b,c){if(null!==b){if(b=Math.round(b),c=Math.round(c),c<0)return Promise.reject("bad duration");if(0===c)return a.scrollTop=b,Promise.resolve();var d=Date.now(),e=d+c,f=a.scrollTop,g=b-f,h=function(a,b,c){if(c<=a)return 0;if(c>=b)return 1;var d=(c-a)/(b-a);return d*d*(3-2*d)};return new Promise(function(c,i){var j=a.scrollTop,k=function(){if(a.scrollTop!=j)return void i({el:a,target:b});var l=Date.now(),m=h(d,e,l),n=Math.round(f+g*m);return a.scrollTop=n,l>=e?void c():a.scrollTop===j&&a.scrollTop!==n?void c():(j=a.scrollTop,void requestAnimationFrame(k))};requestAnimationFrame(k)})["catch"](function(a){a.el.scrollTop=a.target})}};this.toggleLogin=function(a){"boolean"==typeof a?this.loginExpanded(a):this.loginExpanded(!this.loginExpanded())},this.toggleDirections=function(a){"boolean"==typeof a?this.directionsExpanded(a):this.directionsExpanded(!this.directionsExpanded())},this.contains=function(a,b){for(var c=!1,d=0,e=b.length;d<e;d++)a.indexOf(b.charAt(d))>-1&&(c=!0);return c},this.login=function(){var a=this.user();if(a){if(a===this.currentUser())return void b.newAlert({title:"nice try.",details:"You're already logged in!"});var c="users/"+this.user();a&&!this.contains(a," .#$[]")?this.myDataRef.child(c).once("value",function(c){var d=c.val();if(d)b.newAlert({title:"welcome back, "+a,details:"You are logged in. Feel free to explore and favorite any locations you find enjoyable."}),b.currentUser(a),b.importUserFavorites(a);else{var e={};e[a]="No favorites yet.",b.usersRef.update(e,function(c){c?b.newAlert({title:"login error",details:"The user profile could not be created at this time. Please try again later.",duration:4e3}):b.newAlert({title:"welcome, "+a,details:"The user profile was successfully created. Feel free to explore and favorite any locations around the world you find enjoyable.",duration:4e3})})}b.loggedIn(!0),b.loggedInUser=b.user(),b.localStorageAvailable&&(localStorage.user=a)},function(a){a&&b.newAlert({title:"database error",details:"There was an error contacting the database. Please check the connection and try again."})}):b.newAlert({title:"user error",details:'Please use a valid name. Paths must be non-empty strings, not containing the following characters: ". # $ [ ]".'})}},this.toggleVenueFavorite=function(a){b.loggedIn()?b.checkUserFavorites(b.loggedInUser,a,"favorite"):b.newAlert({title:"login required",details:"Please login or create a user profile first, and try again."})},this.logout=function(){b.currentUser(""),b.user(""),b.loggedIn(!1),b.emptyUserFavorites(),b.newAlert({title:"so long, adieu",details:"You have successfully logged out. Check back in again soon!"}),b.localStorageAvailable&&(localStorage.user="")},this.favoriteVenue=function(a,c){var d=this.loggedInUser;if(a)c.favorited(!1);else{var e={};e.id=c.id,this.usersRef.child(d).push().update(e,function(a){a?b.newAlertTitle({title:"database error",details:"There was an error while handling user favorites. Please try again later."}):c.favorited(!0)})}},this.checkUserFavorites=function(a,c,d){this.usersRef.child(a).once("value",function(a){var e,f,g,h,i=c.id,j=a.numChildren();j?(h=a.forEach(function(a){e=a.val(),g=a.key(),f=e.id;var h=f===i;if(h)return b.userAction(h,c,d,g,j),h}),h||b.userAction(h,c,d)):b.userAction(h,c,d)},function(a){a&&b.newAlert({title:"database error",details:"There was an error contacting the database. Please check the connection and try again."})})},this.userAction=function(a,c,d,e,f){var g=this.loggedInUser;switch(d){case"favorite":if(a){var h=g+"/"+e;if(f>1)this.usersRef.child(h).remove(function(a){a&&b.newAlert({title:"database error",details:"There was an error contacting the database. Please check the connection and try again."})}),c.favorited(!1);else{var i={};i[g]="No favorites yet.",b.usersRef.update(i,function(a){a&&b.newAlert({title:"favorite error",details:"There was an error in saving the user favorite. Please try again later."})})}c.favorited(!1)}else this.favoriteVenue(a,c),c.favorited(!0);break;case"import":a?c.favorited(!0):c.favorited(!1)}},this.importUserFavorites=function(a){for(var b,c=this.venuesArray(),d=0,e=c.length;d<e;d++)b=c[d],this.checkUserFavorites(a,b,"import")},this.emptyUserFavorites=function(){for(var a,b=this.venuesArray(),c=0,d=b.length;c<d;c++)a=b[c],a.favorited(!1)},this.showDirections=function(){if(b.animatedDirectionsAvailable()){var a=0;b.venuesArray().forEach(function(c){a+=1,setTimeout(function(){b.showDirection(c)},1e3*a)})}},this.showDirection=function(a){if(a.directionFetched())b.renderDirection(a);else{b.getDirection(a);var c=a.directionFetched.subscribe(function(){b.renderDirection(a),c.dispose(),c=null})}},this.getDirection=function(a){a.directionsService.route({origin:b.coordinates(),destination:{lat:a.location.lat,lng:a.location.lng},travelMode:"DRIVING"},function(c,d){if("OK"===d){var e=c.routes[0].overview_path;a.route=new app.Route({points:e}),a.directionData=c,a.directionFetched(!0)}else b.newAlert({title:"the old fashioned way",details:"Directions aren't all available right now. You might have to ask someone around you. Ew."})})},this.renderDirection=function(a){a.route.render({animationSpeed:50,steps:5,polylineOptions:{strokeColor:"#50bfe6",strokeWeight:3,strokeOpacity:.4}})},this.closeInfoWindow=function(){app.infoWindow&&($(".infoBox").removeClass("entering").addClass("leaving"),app.infoWindow.close())},this.init()};app.viewModel=new a,ko.applyBindings(app.viewModel)}();