var app=app||{};!function(){app.initializeMap=function(){function a(a){var b=[{featureType:"administrative.locality",elementType:"all",stylers:[{hue:"#2c2e33"},{saturation:7},{lightness:19},{visibility:"on"}]},{featureType:"landscape",elementType:"all",stylers:[{hue:"#ffffff"},{saturation:-100},{lightness:100},{visibility:"simplified"}]},{featureType:"poi",elementType:"all",stylers:[{hue:"#ffffff"},{saturation:-100},{lightness:100},{visibility:"off"}]},{featureType:"road",elementType:"geometry",stylers:[{hue:"#bbc0c4"},{saturation:-93},{lightness:31},{visibility:"simplified"}]},{featureType:"road",elementType:"labels",stylers:[{hue:"#bbc0c4"},{saturation:-93},{lightness:31},{visibility:"on"}]},{featureType:"road.arterial",elementType:"labels",stylers:[{hue:"#bbc0c4"},{saturation:-93},{lightness:-2},{visibility:"simplified"}]},{featureType:"road.local",elementType:"geometry",stylers:[{hue:"#e9ebed"},{saturation:-90},{lightness:-8},{visibility:"simplified"}]},{featureType:"transit",elementType:"all",stylers:[{hue:"#e9ebed"},{saturation:10},{lightness:69},{visibility:"on"}]},{featureType:"water",elementType:"all",stylers:[{hue:"#e9ebed"},{saturation:-78},{lightness:67},{visibility:"simplified"}]}],c=[{featureType:"all",elementType:"labels",stylers:[{visibility:"on"}]},{featureType:"all",elementType:"labels.text.fill",stylers:[{saturation:36},{color:"#000000"},{lightness:40}]},{featureType:"all",elementType:"labels.text.stroke",stylers:[{visibility:"on"},{color:"#000000"},{lightness:16}]},{featureType:"all",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"administrative",elementType:"geometry.fill",stylers:[{color:"#000000"},{lightness:20}]},{featureType:"administrative",elementType:"geometry.stroke",stylers:[{color:"#000000"},{lightness:17},{weight:1.2}]},{featureType:"administrative.country",elementType:"labels.text.fill",stylers:[{color:"#e5c163"}]},{featureType:"administrative.locality",elementType:"labels.text.fill",stylers:[{color:"#c4c4c4"}]},{featureType:"administrative.neighborhood",elementType:"labels.text.fill",stylers:[{color:"#e5c163"}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#000000"},{lightness:20}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#000000"},{lightness:21},{visibility:"on"}]},{featureType:"poi.business",elementType:"geometry",stylers:[{visibility:"on"}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#e5c163"},{lightness:"0"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{visibility:"off"}]},{featureType:"road.highway",elementType:"labels.text.fill",stylers:[{color:"#ffffff"}]},{featureType:"road.highway",elementType:"labels.text.stroke",stylers:[{color:"#e5c163"}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#000000"},{lightness:18}]},{featureType:"road.arterial",elementType:"geometry.fill",stylers:[{color:"#575757"}]},{featureType:"road.arterial",elementType:"labels.text.fill",stylers:[{color:"#ffffff"}]},{featureType:"road.arterial",elementType:"labels.text.stroke",stylers:[{color:"#2c2c2c"}]},{featureType:"road.local",elementType:"geometry",stylers:[{color:"#000000"},{lightness:16}]},{featureType:"road.local",elementType:"labels.text.fill",stylers:[{color:"#999999"}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#000000"},{lightness:19}]},{featureType:"water",elementType:"geometry",stylers:[{color:"#000000"},{lightness:17}]}];app.lightMode=new google.maps.StyledMapType(b,{name:"Light Mode"}),app.lightIcon="img/target_light.svg",app.darkMode=new google.maps.StyledMapType(c,{name:"Dark Mode"}),app.darkIcon="img/target_dark.svg",app.geocoder=new google.maps.Geocoder,app.mapOptions={center:{lat:41.90278349999999,lng:12.496365500000024},disableDefaultUI:!0,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,"map_style"]}},navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){var c={lat:b.coords.latitude,lng:b.coords.longitude};app.viewModel.coordinates(c),app.mapOptions.center=c,app.map=new google.maps.Map(document.getElementById("mapDiv"),app.mapOptions),a?(app.infoWindow=new InfoBox({disableAutoPan:!1,pixelOffset:new google.maps.Size((-140),(-24)),zIndex:null,alignBottom:!0,boxStyle:{background:"white",width:"280px","box-radius":"2px","box-shadow":"1px 2px 6px rgba(0, 0, 0, 0.3)"},closeBoxURL:"",infoBoxClearance:new google.maps.Size(1,1),isHidden:!1,pane:"floatPane",enableEventPropagation:!1}),google.maps.event.addListener(app.infoWindow,"domready",function(){$(".infoBox").addClass("entering"),$(".infowindow-close-button").click(function(){app.viewModel.toggleVenueExpand(app.viewModel.selected())})})):app.infoWindow=new google.maps.InfoWindow,google.maps.event.addListener(app.infoWindow,"closeclick",function(){$(".infoBox").toggleClass("entering leaving");var a=app.viewModel.selected();app.viewModel.toggleVenueExpand(a)}),google.maps.event.addDomListener(window,"resize",function(){var a=app.map.getCenter();google.maps.event.trigger(app.map,"resize"),app.map.setCenter(a),app.mapBounds&&app.map.fitBounds(app.mapBounds)}),app.viewModel.initializeTime(),c.lat===c.lng===0?app.viewModel.handleLocationError():app.viewModel.geoLocate(c.lat,c.lng)},function(){app.viewModel.handleLocationError()},{timeout:7500}):app.viewModel.handleLocationError(),app.mapBounds=new google.maps.LatLngBounds}$.getScript("lib/infobox/infobox.js").done(function(){a(!0)}).fail(function(){a(!1)})},app.mapFallback=function(){app.viewModel.constructAlert({title:"google maps error",details:"There was an error loading the map. Please refresh the page and try again."}),app.viewModel.loading(!1)}}();var app=app||{};!function(){var a=function(){function a(){return Math.floor(1e12*Math.random()).toString()}var b,c=this;this.loading=ko.observable(!0),this.alerting=ko.observable(!0),this.initialSearch=ko.observable(!0),this.alertTitle=ko.observable("geolocation note"),this.alertDetails=ko.observable("For best results enable browser geolocation, or attempt a new search.");var d=function(a){this.FoursquareURL=c.Foursquare.baseVenueURL+a.id,this.name=a.name,this.domID=a.name.toLowerCase().split(" ").join("-").replace(/[^a-zA-Z0-9-]/g,""),this.location=a.location,this.id=a.id,this.setCategories(a.categories),this.setHours(a.hours),this.setRating(a.rating),this.setPrice(a.price),this.contact=a.contact,this.url=a.url,this.setPhone(this.contact.phone),this.setPhotos(a.featuredPhotos),this.multiPhotos=ko.observable(!1),this.venueVisible=ko.observable(!0),this.venueExpanded=ko.observable(!1),this.favorited=ko.observable(!1),this.marker=new c.Marker(this)};d.prototype.setCategories=function(a){this.categories=a&&a.length?a:[{name:"Miscellaneous "}]},d.prototype.setHours=function(a){this.hours=a?a:{isOpen:null,status:"Hours not available"}},d.prototype.setRating=function(a){a=parseFloat(a).toFixed(1),this.rating="NaN"===a?"--":a},d.prototype.setPrice=function(a){this.price=a?a:{tier:0}},d.prototype.setPhone=function(a){a&&10===a.length&&(this.review=ko.observable("Loading Yelp review"),this.yelpURL=ko.observable())},d.prototype.setPhotos=function(a){if(this.currentPic=0,a&&a.items.length){var b=a.items[this.currentPic];b.size="250x100",this.photoURL=ko.observable(b.prefix+b.size+b.suffix),this.infowindowPic=this.photoURL()}},this.init=function(){this.configFoursquare(),this.configFlickr(),this.yelpKeySecret="EbOO2hHGytkLpd1lycWv7K-faa4",this.yelpTokenSecret="oZEPYCr8TQ2cNaqrDN7_G0ISsis",this.initializeObservables()},this.initializeObservables=function(){this.searchTerm=ko.observable("Popular"),this.poi=ko.observable(""),this.rangeVisible=ko.observable(!1),this.coordinates=ko.observable({lat:"",lng:""}),this.latLng=ko.computed(function(){return this.coordinates().lat+","+this.coordinates().lng},this),this.filterQuery=ko.observable(""),this.anchorMarker=ko.observable(),this.venuesArray=ko.observableArray(),this.placesExpanded=ko.observable(!1),this.currentMode=ko.observable(""),this.user=ko.observable(""),this.loggedIn=ko.observable(!1),this.loginExpanded=ko.observable(!1),this.selected=ko.observable(null),this.shouldScroll=ko.observable(!1)},this.handleLocationError=function(){$.getJSON("https://freegeoip.net/json/").done(function(a){var b={lat:a.latitude,lng:a.longitude};c.coordinates(b),app.mapOptions.center=b,app.map=new google.maps.Map(document.getElementById("mapDiv"),app.mapOptions),google.maps.event.addDomListener(window,"resize",function(){var a=app.map.getCenter();google.maps.event.trigger(app.map,"resize"),app.map.setCenter(a)}),c.initializeTime(),c.geoLocate(b.lat,b.lng)}).fail(function(a){c.poi("Rome"),c.coordinates({lat:41.90278349999999,lng:12.496365500000024}),app.mapOptions.pos=c.coordinates(),app.map=new google.maps.Map(document.getElementById("mapDiv"),app.mapOptions),c.initializeTime(),google.maps.event.addDomListener(window,"resize",function(){var a=app.map.getCenter();google.maps.event.trigger(app.map,"resize"),app.map.setCenter(a)}),c.constructAlert({title:"geolocation failed",details:"All roads lead to Rome. But for a personalized experience please enable browser geolocation and try again, or attempt a new search."}),c.toggleAlert("open"),c.updateSearch()})},this.getLocalUser=function(){var a=localStorage.user;a?(c.user(a),c.login()):(c.constructAlert({title:"welcome!",details:"Feel free to explore the map, create a user profile, and favorite locations."}),c.toggleAlert("open"))},this.getLastSearch=function(){localStorage.lastPOI,localStorage.lastTerm},this.configFoursquare=function(){this.Foursquare={cID:"AHMKTGNPJOKRI5HSWIQ4GZVRFDXUA2UD4T4ZRBIYRN413QL5",cSecret:"S3D4Y0R1430KP33VNL3MZW320ZFV22YQ2VT02SUX2XCTAD5R",APIbaseURL:"https://api.foursquare.com/",baseVenueURL:"https://foursquare.com/v/",version:"20140601",defaultQuery:ko.observable("topPicks"),radius:ko.observable(1e4)}},this.configFlickr=function(){this.Flickr={key:"&api_key=e3ce05cd3fe0a8e29946f1afa5afc492",secret:"1c5a3dd9614db005",method:"&method=flickr.photos.search",APIbaseURL:"https://api.flickr.com/services/rest/?format=json",sort:"&sort=interestingness-desc",mode:"&nojsoncallback=1"}},this.getYelpParams=function(b){return{oauth_consumer_key:"cNPz9LqhgDj8zRplQ9P_FQ",oauth_token:"CtUW644wLDpJK0flWMnh2aaZI1outOUw",oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",oauth_nonce:a(),oauth_timestamp:Math.floor(Date.now()/1e3),phone:b}},this.getYelpData=function(a){var b="https://api.yelp.com/v2/phone_search",d=this.getYelpParams(a.contact.phone),e=oauthSignature.generate("GET",b,d,c.yelpKeySecret,c.yelpTokenSecret);d.oauth_signature=e;var f={url:b,data:d,cache:!0,dataType:"jsonp"};$.ajax(f).done(function(b){var c=b.businesses[0],d="No Yelp review available.";c&&(d=c.snippet_text,a.yelpURL(c.url)),a.review(d)}).fail(function(a){c.constructAlert({title:"Yelp error",details:"There was an error with the Yelp API. Some requested data may be unavailable at this time. Please try again.",delay:2e3}),c.toggleAlert("open")})},this.expandPlaces=function(){this.placesExpanded(!this.placesExpanded()),this.shouldScroll()&&(this.shouldScroll(!1),this.scrollToLocation(this.selected().domID))},this.expandRangeOptions=function(){c.rangeVisible(!c.rangeVisible())},this.toggleAlert=function(a,b){"open"===a?this.alerting(!0):this.alerting(!1)},this.constructAlert=function(a){var b=a.delay||0;setTimeout(function(){c.alertTitle(a.title),c.alertDetails(a.details)},b)},this.initializeTime=function(){var a=(new Date).getHours();a<=19&&a>=7?c.currentMode("light"):c.currentMode(""),c.toggleMapMode()},this.updateSearch=function(){if(c.poi()){c.loading(!0);var a=new google.maps.places.PlacesService(app.map),b={query:c.poi()};a.textSearch(b,c.updateLatLng)}else c.constructAlert({title:"invalid search",details:"Please enter a valid location. Specific locations yield accurate results."}),c.toggleAlert("open")},this.updateLatLng=function(a,b){if(b==google.maps.places.PlacesServiceStatus.OK){if(a){var d=a[0].geometry.location;c.coordinates({lat:d.lat(),lng:d.lng()})}}else c.constructAlert({title:"google maps error",details:"There was an issue while discovering the specified location. Please try again."}),c.toggleAlert("open");var e=c.coordinates().lat,f=c.coordinates().lng;c.hideMarkers(),app.mapBounds=new google.maps.LatLngBounds,c.anchorMarker(new google.maps.Marker({map:app.map,position:{lat:e,lng:f},icon:"light"===c.currentMode()?app.lightIcon:app.darkIcon,size:new google.maps.Size(5,5),title:"Showing locations near:",animation:google.maps.Animation.DROP})),google.maps.event.addListener(c.anchorMarker(),"click",function(a,b){return function(){b.setContent('<div class="infowindow"><h3 class="infowindow-title">'+c.poi()+"</h3></div>"),b.open(app.map,this),app.map.panTo(a.getPosition()),app.map.panBy(0,-75),app.map.setZoom(12)}}(c.anchorMarker(),app.infoWindow)),app.mapBounds.extend(new google.maps.LatLng(e,f)),c.getVenuesData()},this.hideMarkers=function(){var a=c.venuesArray().length;c.anchorMarker()&&(c.anchorMarker().setMap(null),c.anchorMarker(""));for(var b,d=0;d<a;d++)b=c.venuesArray()[d],b.marker.marker.setMap(null)},this.getVenuesData=function(){c.venuesArray([]);var a;c.searchTerm()&&"popular"!==c.searchTerm().toLowerCase()?a="&query="+c.searchTerm().split(" ").join("&"):(c.searchTerm("Popular"),a="&section="+c.Foursquare.defaultQuery());var b=c.Foursquare.APIbaseURL+"v2/venues/explore?client_id="+c.Foursquare.cID+"&client_secret="+c.Foursquare.cSecret+"&v="+c.Foursquare.version+a+"&radius="+c.Foursquare.radius()+"&ll="+c.latLng()+"&time=any&day=any&limit=35&venuePhotos=1";$.getJSON(b).done(function(a){var b,e=a.response.groups[0].items;if(e.length)for(var f=0,g=e.length;f<g;f++)b=e[f].venue,c.venuesArray.push(new d(b));else c.constructAlert({title:"try another search",details:"Just as with the meaning of life, this search provided no concrete results. Please try a valid search with a specific location for accurate results."}),c.toggleAlert("open"),c.loading(!1);setTimeout(function(){app.map.fitBounds(app.mapBounds),app.map.setCenter(app.mapBounds.getCenter()),c.orderVenues(),!c.loggedIn()&&c.initialSearch()?(c.myDataRef=new Firebase("https://fendneighborhoodmap.firebaseio.com/"),c.usersRef=c.myDataRef.child("users"),c.venuesRef=c.myDataRef.child("venues"),c.localStorageAvailable=!0,c.getLocalUser(),c.initialSearch(!1)):c.loggedIn()&&c.importUserFavorites(c.loggedInUser);for(var a,b,d=c.venuesArray(),e=0,f=d.length;e<f;e++)a=d[e],b=a.contact.phone,c.getPhotos(a),b&&10===b.length&&c.getYelpData(a);c.loading(!1)},500)}).fail(function(a){c.constructAlert({"this":"foursquare error",details:"There was an error with the Foursquare query. Please try again momentarily, or refine the query."}),c.toggleAlert("open")})},this.orderVenues=function(){var a=c.venuesArray(),b=a.sort(function(a,b){return a.rating>b.rating||"NaN"===b.rating?-1:b.rating>a.rating||"NaN"===a.rating?1:0});c.venuesArray(b)},this.getPhotos=function(a){var b=a.location.lat,d=a.location.lng,e=c.Flickr.APIbaseURL+c.Flickr.key+c.Flickr.method+c.Flickr.mode+c.Flickr.sort+"&lat="+b+"&lon="+d+"&text="+a.name;$.getJSON(e).done(function(b){var c=b.photos.photo;if(c.length){var d,e;c.forEach(function(b){d="https://farm"+b.farm+".staticflickr.com/",e=b.server+"/"+b.id+"_"+b.secret+".jpg",a.featuredPhotos||(a.featuredPhotos={items:[]}),a.featuredPhotos.items.push({prefix:d,suffix:e,size:""})}),a.multiPhotos(a.featuredPhotos.items.length>1)}}).fail(function(a){c.constructAlert({title:"flickr error",details:"There was a problem harvesting Flickr photos for the venues. Please try again later.",delay:3e3}),c.toggleAlert("open")})},this.Marker=function(a){var b=this;if(this.lat=a.location.lat,this.lng=a.location.lng,this.pos={lat:this.lat,lng:this.lng},this.name=a.name,a&&a.categories&&a.categories[0]&&a.categories[0].icon){this.icon=a.categories[0].icon;var d="bg_";this.size="32";var e=this.icon.prefix,f=this.icon.suffix;this.iconImage=e+d+this.size+f}else this.iconImage="img/question.svg";this.marker=new google.maps.Marker({map:app.map,position:this.pos,icon:this.iconImage,size:new google.maps.Size(5,5),title:this.name,animation:google.maps.Animation.DROP}),this.placeRating=a.rating||"No rating",this.placePrice=new Array(a.price.tier+1).join("$")||"No price";var g=a.infowindowPic||"";this.marker.content='<div class="infowindow"><button class="infowindow-close-button"><i class="fa fa-close infowindow-close-icon"></i></button>'+(g?'<div class="infowindow-pic" style="background-image: url('+g+'); height: 138px"></div>':"")+'<div class="infowindow-content"><h3 class="infowindow-title">'+this.name+'</h3><div class="infowindow-info"><h4 class="infowindow-rating">Rating: '+this.placeRating+'</h4><h4 class="infowindow-price">Price: '+this.placePrice+"</h4></div></div></div>",google.maps.event.addListener(this.marker,"click",function(a){return function(){c.toggleVenueExpand(a)}}(a)),app.mapBounds.extend(new google.maps.LatLng(b.lat,b.lng))},this.cyclePics=function(a,b){var c=b.featuredPhotos;if(c&&c.items.length){var d=c.items.length;"backwards"===a?b.currentPic>0?b.currentPic--:b.currentPic=d-1:b.currentPic<d-1?b.currentPic++:b.currentPic=0;var e=c.items[b.currentPic];b.photoURL(e.prefix+e.size+e.suffix)}},this.chooseVenue=function(a,c){b&&clearTimeout(b),this.placesExpanded()?this.scrollToLocation(a.domID):this.shouldScroll(!0);var d=this.selected();d&&(d.venueExpanded(!1),d.marker.marker.setAnimation(null)),this.selected(a),a.marker.marker.setMap(app.map),app.infoWindow.setContent(a.marker.marker.content),this.toggleMarkerBounce(!0,a.marker.marker),app.infoWindow.open(app.map,a.marker.marker),app.map.setZoom(12),app.map.panTo(a.marker.marker.getPosition()),app.map.panBy(0,-75)},this.toggleMarkerBounce=function(a,b){a?b.setAnimation(google.maps.Animation.BOUNCE):b.setAnimation(null)},this.showAll=function(a){this.closeInfoWindow();for(var b,c=this.venuesArray().length,d=0;d<c;d++)b=this.venuesArray()[d],b.venueVisible(!0),b.marker.marker.setMap(app.map),b.venueExpanded(!1);app.map.fitBounds(app.mapBounds)},this.showFavorites=function(a){this.closeInfoWindow();var b,c=this.venuesArray().length;if(this.loggedIn()){for(var d=0;d<c;d++)b=this.venuesArray()[d],b.favorited()?b.marker.marker.setMap(app.map):(b.venueVisible(!1),b.marker.marker.setMap(null)),b.venueExpanded(!1);app.map.fitBounds(app.mapBounds)}else this.constructAlert({title:"no favorites yet",details:"You must create a new user profile or be logged in to use this feature."}),this.toggleAlert("open")},this.geoLocate=function(a,b){var d;this.loading(!0),"number"==typeof a&&"number"==typeof b?(d=new google.maps.LatLng(a,b),app.geocoder?app.geocoder.geocode({latLng:d},function(a,b){b==google.maps.GeocoderStatus.OK?c.getLocations(a):(c.constructAlert({title:"google maps error",details:"There was an issue while discovering the specified location. Please try again."}),c.toggleAlert("open"))}):(c.constructAlert({title:"google maps error",details:"There was an error with the map. Please refresh the page and try again."}),c.toggleAlert("open"))):navigator.geolocation.getCurrentPosition(function(a){d=new google.maps.LatLng(a.coords.latitude,a.coords.longitude),app.geocoder?app.geocoder.geocode({latLng:d},function(a,b){b==google.maps.GeocoderStatus.OK?(c.poi(a[0].address_components[2].long_name),c.coordinates({lat:d.lat(),lng:d.lng()}),c.loading(!0),c.updateLatLng("",b)):(c.constructAlert({title:"google maps error",details:"There was an issue while discovering the specified location. Please try again."}),c.toggleAlert("open"))}):(c.constructAlert({title:"google maps error",details:"There was an error with the map. Please refresh the page and try again."}),c.toggleAlert("open"))},c.handleLocationError)},this.getLocations=function(a){this.hideMarkers();var d=this.coordinates().lat,e=this.coordinates().lng;this.anchorMarker()&&(this.anchorMarker().setMap(null),this.anchorMarker("")),this.anchorMarker(new google.maps.Marker({map:app.map,position:{lat:d,lng:e},icon:"light"===c.currentMode()?app.lightIcon:app.darkIcon,title:"Showing locations near:",size:new google.maps.Size(5,5)})),google.maps.event.addListener(this.anchorMarker(),"click",function(a,d){return function(){b&&clearTimeout(b),c.selected()&&c.toggleVenueExpand(c.selected()),d.setContent('<div class="infowindow"><h3 class="infowindow-title">'+c.poi()+"</h3></div>"),d.open(app.map,this),b=setTimeout(function(){c.closeInfoWindow()},3e3),app.map.panTo(a.getPosition()),app.map.panBy(0,-75),app.map.setZoom(12)}}(this.anchorMarker(),app.infoWindow)),app.mapBounds=new google.maps.LatLngBounds,app.mapBounds.extend(new google.maps.LatLng(d,e)),this.poi(a[0].address_components[2].long_name),this.getVenuesData()},this.toggleMapMode=function(){"light"===this.currentMode()?(this.anchorMarker()&&this.anchorMarker().setIcon(app.darkIcon),app.map.mapTypes.set("map_style",app.lightMode),app.map.setMapTypeId("map_style"),this.currentMode("")):(this.anchorMarker()&&this.anchorMarker().setIcon(app.lightIcon),app.map.mapTypes.set("map_style",app.darkMode),app.map.setMapTypeId("map_style"),this.currentMode("light"))},this.filterVenues=function(){for(var a,b=this.venuesArray().length,c=this.filterQuery().toLowerCase(),d=0;d<b;d++){var e=this.venuesArray()[d];a=e.name.toLowerCase(),a.indexOf(c)>=0?(e.venueVisible(!0),e.marker.marker.setMap(app.map)):(e.venueVisible(!1),e.marker.marker.setMap(null))}},this.toggleVenueExpand=function(a,b){a.venueExpanded()?(c.closeInfoWindow(),c.toggleMarkerBounce(!1,a.marker.marker),c.scrollToLocation(),c.selected(null),c.shouldScroll(!1)):(c.selected()&&c.selected().venueExpanded(!1),c.chooseVenue(a,b)),a.venueExpanded(!a.venueExpanded())},this.scrollToLocation=function(a,b){var c=document.getElementById("places-list-section"),d=135,f=a?document.getElementById(a).offsetTop-d:null,g=500;f&&f<0&&(f=0),e(c,f,g)};var e=function(a,b,c){if(null!==b){if(b=Math.round(b),c=Math.round(c),c<0)return Promise.reject("bad duration");if(0===c)return a.scrollTop=b,Promise.resolve();var d=Date.now(),e=d+c,f=a.scrollTop,g=b-f,h=function(a,b,c){if(c<=a)return 0;if(c>=b)return 1;var d=(c-a)/(b-a);return d*d*(3-2*d)};return new Promise(function(c,i){var j=a.scrollTop,k=function(){if(a.scrollTop!=j)return void i({el:a,target:b});var l=Date.now(),m=h(d,e,l),n=Math.round(f+g*m);return a.scrollTop=n,l>=e?void c():a.scrollTop===j&&a.scrollTop!==n?void c():(j=a.scrollTop,void requestAnimationFrame(k))};requestAnimationFrame(k)})["catch"](function(a){a.el.scrollTop=a.target})}};this.toggleLogin=function(){this.loginExpanded(!this.loginExpanded())},this.contains=function(a,b){for(var c=!1,d=0,e=b.length;d<e;d++)a.indexOf(b.charAt(d))>-1&&(c=!0);return c},this.login=function(){var a="users/"+this.user(),b=this.user();b&&!this.contains(b," .#$[]")?this.myDataRef.child(a).once("value",function(a){var d=a.val();if(d)c.constructAlert({title:"welcome back, "+b,details:"You are logged in. Feel free to explore and favorite any locations you find enjoyable.",delay:4e3}),c.toggleAlert("open"),c.importUserFavorites(b);else{var e={};e[b]="No favorites yet.",c.usersRef.update(e,function(a){a?(c.constructAlert({title:"login error",details:"The user profile could not be created at this time. Please try again later.",delay:4e3}),c.toggleAlert("open")):(c.constructAlert({title:"welcome, "+b,details:"The user profile was successfully created. Feel free to explore and favorite any locations around the world you find enjoyable.",delay:4e3}),c.toggleAlert("open"))})}c.loggedIn(!0),c.loggedInUser=c.user(),c.localStorageAvailable&&(localStorage.user=b)},function(a){a&&(c.constructAlert({title:"database error",details:"There was an error contacting the database. Please check the connection and try again."}),c.toggleAlert("open"))}):(c.constructAlert({title:"user error",details:'Please use a valid name. Paths must be non-empty strings, not containing the following characters: ". # $ [ ]".'}),c.toggleAlert("open"))},this.toggleVenueFavorite=function(a){c.loggedIn()?c.checkUserFavorites(c.loggedInUser,a,"favorite"):(c.constructAlert({title:"login required",details:"Please login or create a user profile first, and try again."}),c.toggleAlert("open"))},this.favoriteVenue=function(a,b){var d=this.loggedInUser;if(a)b.favorited(!1);else{var e={};e.id=b.id,this.usersRef.child(d).push().update(e,function(a){a?(c.constructAlertTitle({title:"database error",details:"There was an error while handling user favorites. Please try again later."}),c.toggleAlert()):b.favorited(!0)})}},this.checkUserFavorites=function(a,b,d){this.usersRef.child(a).once("value",function(a){var e,f,g,h,i=b.id,j=a.numChildren();j?(h=a.forEach(function(a){e=a.val(),g=a.key(),f=e.id;var h=f===i;if(h)return c.userAction(h,b,d,g,j),h}),h||c.userAction(h,b,d)):c.userAction(h,b,d)},function(a){a&&(c.constructAlert({title:"database error",details:"There was an error contacting the database. Please check the connection and try again."}),c.toggleAlert("open"))})},this.userAction=function(a,b,d,e,f){var g=this.loggedInUser;switch(d){case"favorite":if(a){var h=g+"/"+e;if(f>1)this.usersRef.child(h).remove(function(a){a&&(c.constructAlert({title:"database error",details:"There was an error contacting the database. Please check the connection and try again."}),c.toggleAlert("open"))}),b.favorited(!1);else{var i={};i[g]="No favorites yet.",c.usersRef.update(i,function(a){a&&(c.constructAlert({title:"favorite error",details:"There was an error in saving the user favorite. Please try again later."}),c.toggleAlert("open"))})}b.favorited(!1)}else this.favoriteVenue(a,b),b.favorited(!0);break;case"import":a?b.favorited(!0):b.favorited(!1)}},this.importUserFavorites=function(a){for(var b,c=this.venuesArray(),d=0,e=c.length;d<e;d++)b=c[d],this.checkUserFavorites(a,b,"import")},this.closeInfoWindow=function(){$(".infoBox").toggleClass("entering leaving"),app.infoWindow.close()},this.init()};app.viewModel=new a,ko.applyBindings(app.viewModel)}();